<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tieshan.api.mapper.tieshanpaiMapper.v1.auction.CarPmAuctionMapper">

    <resultMap id="BaseResultMap" type="Paimai">
        <id 	column="id"  						property="id" />
        <result column="pmh_id"  					property="pmhId" />
        <result column="paimai_name"  				property="paimaiName" />
        <result column="paimai_start_time"  		property="paimaiStartTime" />
        <result column="interval_time"  			property="intervalTime" />
        <result column="paimai_finish_time"  		property="paimaiFinishTime" />
        <result column="single_time"  				property="singleTime" />
        <result column="remark"  					property="remark" />
        <result column="paimai_state"  				property="paimaiState" />
        <result column="paimai_states"  			property="paimaiStates" />
        <result column="publish_time"  				property="publishTime" />
        <result column="auction_count" 				property="auctionCount" />
        <result column="deal_count"  				property="dealCount" />
        <result column="abortive_count"  			property="abortiveCount" />
        <result column="revoke_count"  				property="revokeCount" />
        <result column="create_user"  				property="createUser" />
        <result column="create_time"  				property="createTime" />
        <result column="is_delete"  				property="isDelete" />
        <result column="weekday"  				property="weekDay" />
        <result column="starttime"  				property="startTime" />
    </resultMap>

    <resultMap id="auctionList" type="com.tieshan.api.vo.tieshanpaiVo.v1.auction.CarPmAuctionVo">
        <id 	column="id" 					property="id" />
        <result column="auction_type" 			property="auctionType" />
        <result column="auction_type_s" 		property="auctionTypeS" />
        <result column="auction_no" 			property="auctionNo" />
        <result column="full_name" 				property="fullName" />
        <result column="lot_areas" 				property="lotAreas" />
        <result column="lot_areas_id" 			property="lotAreasId" />
        <result column="create_user" 			property="createUser" />
        <result column="create_time" 			property="createTime" />
        <result column="order_state" 			property="orderState" />
        <result column="auction_start_time" 	property="auctionStartTime" />
        <result column="look_address" 			property="lookAddress" />
        <result column="look_coordinate" 		property="lookCoordinate" />
        <result column="auction_end_time" 	    property="auctionEndTime" />
        <association property="imgPath" column="auctionId=id" javaType="String" select="getHeadImgByAuctionId"/>
    </resultMap>

    <resultMap id="auction" type="com.tieshan.api.vo.tieshanpaiVo.v1.auction.CarPmAuctionVo">
        <id 	column="id" 					property="id" />
        <result column="auction_type" 			property="auctionType" />
        <result column="auction_type_s" 		property="auctionTypeS" />
        <result column="auction_no" 			property="auctionNo" />
        <result column="full_name" 				property="fullName" />
        <result column="vin" 					property="vin" />
        <result column="license_number" 		property="licenseNumber" />
        <result column="lot_areas" 				property="lotAreas" />
        <result column="lot_areas_id" 			property="lotAreasId" />
        <result column="production_date" 		property="productionDate" />
        <result column="is_has_key" 			property="isHasKey" />
        <result column="description" 			property="description" />
        <result column="buy_requirement" 		property="buyRequirement" />
        <result column="look_contacts" 			property="lookContacts" />
        <result column="look_contact_number" 	property="lookContactNumber" />
        <result column="look_address" 			property="lookAddress" />
        <result column="look_coordinate" 		property="lookCoordinate" />
        <result column="bid_notice" 			property="bidNotice" />
        <result column="special_notice" 		property="specialNotice" />
        <result column="is_delete" 				property="isDelete" />
        <result column="create_user" 			property="createUser" />
        <result column="create_time" 			property="createTime" />
        <result column="starting_price" 		property="startingPrice" />
        <result column="order_state" 			property="orderState" />
        <result column="order_state_s" 			property="orderStateS" />
        <result column="commission" 			property="commission" />
        <result column="other_price" 			property="otherPrice" />
        <result column="auction_start_time" 	property="auctionStartTime" />
        <result column="auction_end_time" 	    property="auctionEndTime" />
        <result column="parts_count"            property="lotPartsCount" />
        <result column="parts_weight"           property="partsWeight" />
        <collection property="auctionFileList" ofType="com.tieshan.api.vo.tieshanpaiVo.v1.auction.CarPmAuctionFileVo" column="auctionId=id"
                    select="getFileListByAuctionId">
        </collection>
        <collection property="autopartsList" ofType="com.tieshan.api.vo.chebaofeiVo.v1.CarScrapOrderAutopartsVo" column="auctionId=id"
                    select="getCarScrapOrderAutopartsListByAuctionId">
        </collection>
    </resultMap>

    <resultMap id="carScrapOrderAutopartsVo"  type="com.tieshan.api.vo.chebaofeiVo.v1.CarScrapOrderAutopartsVo">
        <id  column="id"     property="id" />
        <result column="order_id"     property="orderId" />
        <result column="order_no"     property="orderNo" />
        <result column="parts_type"    property="partsType" />
        <result column="parts_name"    property="partsName" />
        <result column="parts_num"     property="partsNum" />
        <result column="car_model_number"   property="carModelNumber" />
        <result column="car_frame_number"   property="carFrameNumber" />
        <result column="car_number"    property="carNumber" />
    </resultMap>

    <resultMap id="auctionCar" type="AuctionCar">
        <id 	column="auction_id" 			property="auctionId" />
        <result column="auction_set_id" 		property="auctionSetId" />
        <result column="auction_no" 			property="auctionNo" />
        <result column="full_name" 				property="fullName" />
        <result column="full_type" 				property="fullType" />
        <result column="lot_areas" 				property="lotAreas" />
        <result column="vehicle_brand" 			property="vehicleBrand" />
        <result column="vehicle_type" 			property="vehicleType" />
        <result column="vehicle_system" 		property="vehicleSystem" />
        <result column="license_number" 		property="licenseNumber" />
        <result column="pmh_id" 				property="pmhId" />
        <result column="pm_order" 				property="pmOrder" />
        <result column="order_state_s" 			property="orderStateS" />
        <result column="order_state" 			property="orderState" />
        <result column="deal_mid" 				property="dealMid" />
        <result column="deal_member" 			property="dealMember" />
        <result column="starting_price" 		property="startingPrice" />
        <result column="cur_price" 				property="curPrice" />
        <result column="reserve_price" 			property="reservePrice" />
        <result column="auction_cash_deposit" 	property="auctionCashDeposit" />
        <result column="auction_type_flag" 		property="auctionTypeFlag" />
        <result column="vin" 					property="vin" />
        <result column="park_address" 			property="parkAddress" />
        <result column="phone" 					property="phone" />
        <result column="id_card" 				property="idCard" />
        <result column="joint_price" 			property="jointPrice" />
        <result column="highest_price" 			property="highestPrice" />
        <result column="other_price" 			property="otherPrice" />
        <result column="commission" 			property="commission" />
        <result column="total_price" 			property="totalPrice" />
        <association property="imgPath" column="auctionId=auction_id" javaType="String"
                     select="getHeadImgByAuctionId"/>
    </resultMap>

    <sql id="ListIf">
        <if test="auctionTypeArr.size() > 0 ">
            AND cpa.auction_type in <foreach item="auction_type" index="index" collection="auctionTypeArr" open="(" separator="," close=")">#{auction_type}</foreach>
        </if>
        <if test="lotAreasArr.size() > 0 ">
            AND cpa.lot_areas_id in <foreach item="item" index="index" collection="lotAreasArr" open="(" separator="," close=")">#{item}</foreach>
        </if>
    </sql>

    <sql id="ListIfPaiMai">
        <if test="auctionPlatform != null and auctionPlatform !=''">
            AND SIP.auction_platform = #{auctionPlatform}
        </if>
        <if test="paimaiDateStart != null">
            AND SIP.paimai_start_time <![CDATA[>=]]> #{paimaiDateStart}
        </if>
        <if test="paimaiDateEnd != null">
            AND SIP.paimai_start_time <![CDATA[<=]]> #{paimaiDateEnd}
        </if>
        <if test="paimaiName != null and paimaiName !=''">
            AND SIP.paimai_name like CONCAT(CONCAT('%', #{paimaiName}),'%')
        </if>
    </sql>

    <sql id="getAuctionCarListSQL">
		SIA.id AS auction_id,
	    SIAS.id auction_set_id,
		SIA.auction_no,
		SIA.full_name,
		case SIA.auction_type when 0 then CONCAT('全车配件')
			when 1 then CONCAT('高价值配件')
			when 2 then CONCAT('大宗物资') end AS full_type,
		SIA.lot_areas,
		SIA.vehicle_brand,
	    SIA.vehicle_type,
	    SIA.vehicle_system,
	    SIA.license_number,
	    SIAS.pmh_id,
	    SIAS.pm_order,
	    case SIAS.order_state when '0' then '等待发布' when '10' then '等待竞拍' when '20' then '正在竞拍' when '30' then '等待处理' when '40' then '流拍' when '-8' then '已复拍' when '-9' then '撤拍' when '-10' then '已退货' else '已成交' end
	    AS order_state_s,
	    SIAS.order_state,
	    SIAS.starting_price,
	    SIAS.reserve_price,
	    SIAS.auction_cash_deposit,
	    SIAS.deal_mid,
	    SIAS.deal_member,
	    SIA.vin,
	    SIA.auction_type auction_type_flag,
	    SPCI.phone,
	    SPCI.id_card,
	    SIAS.joint_price,
	    SIAS.commission,
	    SIAS.other_price,
	    SIA.look_address park_address
	</sql>

    <select id="findAuction" resultMap="auctionList">
        (
        SELECT
            *
         FROM
        (
        SELECT
            SYSDATE() as sysDate,
            cpa.id,
            cpa.auction_type,
            CASE
                cpa.auction_type
                WHEN 0 THEN '整车配件'
                WHEN 1 THEN '高价值配件'
                WHEN 2 THEN '大宗物资'
            END AS auction_type_s,
            cpa.full_name,
            cpa.lot_areas,
            cpa.lot_areas_id,
            cpa.look_address, cpa.look_coordinate,
            cpas.order_state,
            cpas.auction_start_time,
            cpas.auction_end_time,
            cpas.id as orderId,
            (SELECT
                MAX(HB.BID_AMOUNT)
             FROM
                car_pm_offer_water HB
             WHERE
                HB.is_delete = 0
                AND HB.ORDER_ID = cpas.id
            )  as  highestPrice
        FROM
            car_pm_auction cpa
        LEFT JOIN
            car_pm_auction_set cpas ON cpa.id = cpas.auction_id
        LEFT JOIN
            car_pm_paimai cpp ON cpas.pmh_id = cpp.pmh_id
        WHERE
            cpa.is_delete = 0
            AND cpas.is_delete = 0
            AND cpas.is_history = 0
            AND cpp.is_delete = 0
            AND cpp.paimai_state in (1,2)
            AND cpas.order_state in ('10','20','30')
        <include refid="ListIf" />
        ORDER BY
            cpas.order_state DESC,
            cpas.pm_order ) as aa
        )
        UNION
        (
        SELECT
           *
        FROM
        (
        SELECT
            SYSDATE() as sysDate,
            cpa.id,
            cpa.auction_type,
            CASE
                cpa.auction_type
                WHEN 0 THEN '整车配件'
                WHEN 1 THEN '高价值配件'
                WHEN 2 THEN '大宗物资'
            END AS auction_type_s,
            cpa.full_name,
            cpa.lot_areas,
            cpa.lot_areas_id,
            cpa.look_address, cpa.look_coordinate,
            cpas.order_state,
            cpas.auction_start_time,
            cpas.auction_end_time,
            cpas.id as orderId,
            (SELECT
                MAX(HB.BID_AMOUNT)
            FROM
                car_pm_offer_water HB
            WHERE
                HB.is_delete = 0
                AND HB.ORDER_ID = cpas.id
            ) as highestPrice
        FROM
            car_pm_auction cpa
        LEFT JOIN
            car_pm_auction_set cpas ON cpa.id = cpas.auction_id
        LEFT JOIN
            car_pm_paimai cpp ON cpas.pmh_id = cpp.pmh_id
        WHERE
            cpa.is_delete = 0
            AND cpas.is_delete = 0
            AND cpas.is_history = 0
            AND cpp.is_delete = 0
            AND cpp.paimai_state in (1,2)
            AND cpas.order_state in ('50')
        <include refid="ListIf" />
        ORDER BY
            cpas.order_state DESC ,
            cpas.pm_order ) as  bb
         )
    </select>

    <select id="findAuctionTotal" resultType="java.lang.Integer">
        SELECT
            COUNT(1)
        FROM
            car_pm_auction cpa
        LEFT JOIN
            car_pm_auction_set cpas ON cpa.id = cpas.auction_id
        LEFT JOIN
            car_pm_paimai cpp ON cpas.pmh_id = cpp.pmh_id
        WHERE
            cpa.is_delete = 0
            AND cpas.is_delete = 0
            AND cpas.is_history = 0
            AND cpp.is_delete = 0
            AND cpp.paimai_state in (1,2)
            AND cpas.order_state in ('10','20','30','50')
        <include refid="ListIf" />
    </select>

    <select id="getAuctionInfo" resultMap="auction">
		SELECT
		    SYSDATE() as sysDate,
			cpa.id,
			cpa.auction_type,
			cpas.id as orderId,
			CASE
			    cpa.auction_type
			    WHEN 0 THEN '整车配件'
			    WHEN 1 THEN '高价值配件'
			    WHEN 2 THEN '大宗物资'
			END AS auction_type_s,
			cpa.auction_no,
			cpa.full_name,
			cpa.vin,
			cpa.parts_count,
			cpa.parts_weight,
			cpa.license_number,
			cpa.lot_areas,
			cpa.lot_areas_id,
			cpa.production_date,
			cpa.is_has_key,
			cpa.description,
			cpa.buy_requirement,
			cpa.look_contacts,
			cpa.look_contact_number,
			cpa.look_address,
			cpa.look_coordinate,
			cpa.bid_notice,
			cpa.special_notice,
			cpa.create_user,
			cpa.create_time,
			cpas.starting_price,
			cpas.order_state,
			CASE
			    cpas.order_state
			    WHEN 10 THEN '未开始'
			    WHEN 20 THEN '竞价中'
			    WHEN 30 THEN '已结束'
			    WHEN 50 THEN '已成交'
			END AS order_state_s,
			cpas.commission,
			cpas.other_price,
			cpas.auction_start_time,
			cpas.auction_end_time,
			 (
			 SELECT
            	  MAX(HB.BID_AMOUNT)
             FROM
                  car_pm_offer_water HB
             WHERE
                  HB.is_delete = 0
			      AND HB.ORDER_ID = cpas.id
			 ) as highestPrice
		FROM
			car_pm_auction cpa
        LEFT JOIN
            car_pm_auction_set cpas
            ON cpa.id = cpas.auction_id
		WHERE
			cpa.id = #{id}
			AND cpas.is_delete = 0
			AND cpas.is_history = 0
	</select>

    <select id="getHeadImgByAuctionId" resultType="String">
		select
			ta.storage_path
		from
			car_pm_auction_file cpf
        left join
            tb_attachment ta on cpf.attachment_id = ta.id
		where
			cpf.auction_id = #{auctionId}
		and
			cpf.is_delete = 0
		and
			ta.isvalid = 1
		order by
			cpf.sort limit 1
	</select>

    <select id="getFileListByAuctionId" resultType="com.tieshan.api.vo.tieshanpaiVo.v1.auction.CarPmAuctionFileVo">
		select
			cpf.id,
			cpf.auction_id,
			cpf.file_type,
			cpf.attachment_id,
			cpf.sort,
			cpf.create_time,
			ta.storage_path img_path
		from
			car_pm_auction_file cpf
		left join
		    tb_attachment ta
		on
		    cpf.attachment_id = ta.id
		where
			cpf.auction_id = #{auctionId}
		and
			cpf.is_delete = 0
		and
			ta.isvalid = 1
		order by
		    cpf.sort
	</select>


    <select id="getCarScrapOrderAutopartsListByAuctionId" resultMap="carScrapOrderAutopartsVo">
	  SELECT
           CSOA.id,
           CSOA.order_id,
           CSOA.parts_type,
           TCP.parts_name,
           CSOA.parts_num,
           CSO.order_no,
           CSO.car_model_number,
           CSO.car_frame_number,
           CSO.car_number
	  FROM
	      car_scrap_order_autoparts CSOA
      LEFT JOIN
          car_scrap_order CSO on CSOA.order_id = CSO.id
	  LEFT JOIN
	      tb_car_parts TCP on CSOA.parts_type = TCP.id
	  WHERE
	      CSOA.auction_id = #{auctionId}
	  AND
	      CSOA.is_valid = 1
	  AND
	      CSO.isremove = 0
	  ORDER BY
	      CSOA.operatortime
 </select>

    <select id="getPaimaiListByPage" resultMap="BaseResultMap">
        SELECT
            SIP.id,
            SIP.pmh_id,
            SIP.paimai_name,
            SIP.paimai_start_time,
            SIP.interval_time,
            SIP.paimai_finish_time,
            SIP.single_time,
            SIP.remark,
            SIP.paimai_state,
            case
                SIP.paimai_state
                when 0 then '等待发布'
                when 1 then '正在竞拍'
                when 2 then '竞拍结束'
            end
            AS paimai_states,
            DATE_FORMAT(SIP.paimai_start_time, '%H:%i') as starttime,
            SIP.publish_time,
            case
                date_format(SIP.publish_time,'%w')
                when 1 then CONCAT(SUBSTRING(publish_time,3,2),'-0',MONTH(publish_time),'-', if(LENGTH(DAY(publish_time))>1,DAY(publish_time),CONCAT('0',DAY(publish_time))),' ','周一')
                when 2 then CONCAT(SUBSTRING(publish_time,3,2),'-0',MONTH(publish_time),'-', if(LENGTH(DAY(publish_time))>1,DAY(publish_time),CONCAT('0',DAY(publish_time))),' ','周二')
                when 3 then CONCAT(SUBSTRING(publish_time,3,2),'-0',MONTH(publish_time),'-', if(LENGTH(DAY(publish_time))>1,DAY(publish_time),CONCAT('0',DAY(publish_time))),' ','周三')
                when 4 then CONCAT(SUBSTRING(publish_time,3,2),'-0',MONTH(publish_time),'-', if(LENGTH(DAY(publish_time))>1,DAY(publish_time),CONCAT('0',DAY(publish_time))),' ','周四')
                when 5 then CONCAT(SUBSTRING(publish_time,3,2),'-0',MONTH(publish_time),'-', if(LENGTH(DAY(publish_time))>1,DAY(publish_time),CONCAT('0',DAY(publish_time))),' ','周五')
                when 6 then CONCAT(SUBSTRING(publish_time,3,2),'-0',MONTH(publish_time),'-', if(LENGTH(DAY(publish_time))>1,DAY(publish_time),CONCAT('0',DAY(publish_time))),' ','周六')
                when 7 then CONCAT(SUBSTRING(publish_time,3,2),'-0',MONTH(publish_time),'-', if(LENGTH(DAY(publish_time))>1,DAY(publish_time),CONCAT('0',DAY(publish_time))),' ','周日')
            END	as weekday,
            SIP.create_user,
            SIP.create_time,
            SIP.is_delete,
            (
             SELECT
                  COUNT(1)
             FROM
                  car_pm_auction_set SIAS
             WHERE
                 SIAS.is_delete = 0
             AND
                 SIAS.pmh_id = SIP.pmh_id
            )AS auction_count,
            (
             SELECT
                COUNT(1)
             FROM
                car_pm_auction_set SIAS
            LEFT JOIN
                car_pm_aftersale SIAA
                on SIAS.id = SIAA.auction_set_id
                AND SIAA.is_delete = 0
                AND SIAA.is_history = 0
            WHERE
                SIAS.pmh_id = SIP.pmh_id
            AND
                SIAA.id is not null
            AND
                SIAS.is_delete = 0
            AND
                SIAS.is_history = 0
            )AS deal_count
        FROM
            car_pm_paimai SIP
        WHERE
            SIP.is_delete=0
        <include refid="ListIfPaiMai" />
        <if test="paimaiState != null">
            AND SIP.paimai_state = #{paimaiState}
        </if>
        order by FIELD(SIP.paimai_state,1,0,2)
        limit #{rows}
    </select>

    <select id="getPaimaiListTotal" resultType="int">
        SELECT
            COUNT(1)
        FROM
            car_pm_paimai SIP
        where
            SIP.is_delete=0
        <include refid="ListIfPaiMai" />
        <if test="paimaiState != null">
            AND SIP.paimai_state = #{paimaiState}
        </if>
    </select>

    <select id="getAuctionCarList" resultMap="auctionCar">
        select
        *
        from
        (
        (
        SELECT
        *
        FROM
        (
        SELECT
        <include refid="getAuctionCarListSQL"/>,
        SPHB.MAXIMUM_PRICE highest_price,
        (SPHB.MAXIMUM_PRICE+SIAS.commission+SIAS.other_price) total_price
        FROM
        car_pm_auction_set SIAS
        LEFT JOIN
        car_pm_auction SIA
        ON SIAS.auction_id = SIA.id
        AND SIA.is_delete = 0
        LEFT JOIN
        car_pm_highest_bid SPHB
        ON SPHB.ORDER_ID = SIAS.id
        LEFT JOIN
        sys_client SPCI
        ON SPCI.id = SIAS.deal_mid
        WHERE
        SIAS.is_delete = 0
        AND
        SIAS.is_history = 0
        AND
        SIAS.pmh_id = #{pmhId}
        AND
        SIAS.order_state = '30'
        ORDER BY
        SIAS.update_time
        DESC
        ) AS list1
        )
        UNION
        (
        SELECT
        *
        FROM
        (
        SELECT
        <include refid="getAuctionCarListSQL"/>,
        SPHB.MAXIMUM_PRICE highest_price,
        (SPHB.MAXIMUM_PRICE+SIAS.commission+SIAS.other_price) total_price
        FROM
        car_pm_auction_set SIAS
        LEFT JOIN
        car_pm_auction SIA
        ON SIAS.auction_id = SIA.id
        AND SIA.is_delete = 0
        LEFT JOIN
        car_pm_highest_bid SPHB
        ON SPHB.ORDER_ID = SIAS.id
        LEFT JOIN
        sys_client SPCI ON SPCI.id = SIAS.deal_mid
        WHERE
        SIAS.is_delete = 0
        AND
        SIAS.is_history = 0
        AND
        SIAS.pmh_id = #{pmhId}
        AND
        SIAS.order_state = '20'
        ORDER BY
        SIAS.pm_order
        ) AS list2
        )
        UNION
        (
        SELECT
        *
        FROM
        (
        SELECT
        <include refid="getAuctionCarListSQL"/>,
        0 highest_price,
        (0+SIAS.commission+SIAS.other_price) total_price
        FROM
        car_pm_auction_set SIAS
        LEFT JOIN
        car_pm_auction SIA
        ON SIAS.auction_id = SIA.id
        AND SIA.is_delete = 0
        LEFT JOIN
        sys_client SPCI
        ON SPCI.id = SIAS.deal_mid
        WHERE
        SIAS.is_delete = 0
        AND
        SIAS.is_history = 0
        AND
        SIAS.pmh_id = #{pmhId}
        AND
        SIAS.order_state in ('0','10')
        ORDER BY
        SIAS.pm_order) AS list3
        )
        UNION
        (
        SELECT
        *
        FROM
        (
        SELECT
        <include refid="getAuctionCarListSQL"/>,
        SIAS.highest_price,
        (SIAS.highest_price+SIAS.commission+SIAS.other_price) total_price
        FROM
        car_pm_auction_set SIAS
        LEFT JOIN
        car_pm_auction SIA
        ON SIAS.auction_id = SIA.id
        AND SIA.is_delete = 0
        LEFT JOIN
        car_pm_highest_bid SPHB
        ON SPHB.ORDER_ID = SIAS.id
        LEFT JOIN
        sys_client SPCI
        ON SPCI.id = SIAS.deal_mid
        WHERE
        SIAS.is_delete = 0
        AND
        SIAS.pmh_id = #{pmhId}
        AND
        SIAS.order_state in ('40','50','60','80','-8','-9','-10')
        ORDER BY
        SIAS.update_time DESC) AS list4
        )
        ) v
        <if test="pmOrderBy != null">
            ORDER BY #{pmOrderBy}
        </if>
    </select>


</mapper>